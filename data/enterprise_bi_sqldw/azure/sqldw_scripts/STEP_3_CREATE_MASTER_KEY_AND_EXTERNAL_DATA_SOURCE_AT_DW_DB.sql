IF  EXISTS (SELECT * FROM SYS.SYMMETRIC_KEYS WHERE NAME  = '##MS_DATABASEMASTERKEY##')
BEGIN
	
	-- EXTERNAL DATASOURCE USES DB SCOPED CREDENTIAL - SO DROP THIS BEFORE DROPING THE DEPENDENCY
	IF EXISTS (SELECT * FROM sys.external_data_sources WHERE NAME ='WAREHOUSEEXTERNALDATASOURCE')
	BEGIN
		DROP EXTERNAL DATA SOURCE WAREHOUSEEXTERNALDATASOURCE
	END 

	-- BEFORE DROPPING MASTER KEY , DROP DB SCOPED CREDENTIAL IF EXISTS
	IF EXISTS (select * from sys.database_scoped_credentials WHERE NAME ='WAREHOUSEBLOBACCESSCRENDENTIAL')
	BEGIN
		DROP DATABASE SCOPED CREDENTIAL WAREHOUSEBLOBACCESSCRENDENTIAL; 
	END	 
	DROP MASTER KEY;
END



CREATE MASTER KEY;

CREATE DATABASE SCOPED CREDENTIAL WAREHOUSEBLOBACCESSCRENDENTIAL
WITH
    IDENTITY = 'user',
    SECRET = '<storage account key>'
;


CREATE EXTERNAL DATA SOURCE WAREHOUSEEXTERNALDATASOURCE
WITH
(
    TYPE = Hadoop,
    LOCATION = 'wasbs://wwi@<storage account name>.blob.core.windows.net',
	CREDENTIAL = WAREHOUSEBLOBACCESSCRENDENTIAL
);



